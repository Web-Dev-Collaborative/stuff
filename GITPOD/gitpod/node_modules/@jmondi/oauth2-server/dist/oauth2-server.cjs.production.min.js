"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("crypto")),r=e(require("ms")),n=e(require("querystring")),i=require("uri-js"),o=e(require("jsonwebtoken"));function s(e,t,r,n,i,o,s){try{var a=e[o](s),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,i)}function a(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function a(e){s(o,n,i,a,c,"next",e)}function c(e){s(o,n,i,a,c,"throw",e)}a(void 0)}))}}function c(){return(c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function u(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function d(e,t,r){return(d=l()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&p(i,r.prototype),i}).apply(null,arguments)}function f(e){var t="function"==typeof Map?new Map:void 0;return(f=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return d(e,arguments,h(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),p(r,e)})(e)}var v,y,g=(function(e){var t=function(e){var t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",s=n.toStringTag||"@@toStringTag";function a(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{a({},"")}catch(e){a=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var i=Object.create((t&&t.prototype instanceof p?t:p).prototype),o=new T(n||[]);return i._invoke=function(e,t,r){var n="suspendedStart";return function(i,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw o;return{value:void 0,done:!0}}for(r.method=i,r.arg=o;;){var s=r.delegate;if(s){var a=R(s,r);if(a){if(a===h)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===h)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,o),i}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var h={};function p(){}function l(){}function d(){}var f={};f[i]=function(){return this};var v=Object.getPrototypeOf,y=v&&v(v(_([])));y&&y!==t&&r.call(y,i)&&(f=y);var g=d.prototype=p.prototype=Object.create(f);function x(e){["next","throw","return"].forEach((function(t){a(e,t,(function(e){return this._invoke(t,e)}))}))}function w(e,t){var n;this._invoke=function(i,o){function s(){return new t((function(n,s){!function n(i,o,s,a){var c=u(e[i],e,o);if("throw"!==c.type){var h=c.arg,p=h.value;return p&&"object"==typeof p&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,s,a)}),(function(e){n("throw",e,s,a)})):t.resolve(p).then((function(e){h.value=e,s(h)}),(function(e){return n("throw",e,s,a)}))}a(c.arg)}(i,o,n,s)}))}return n=n?n.then(s,s):s()}}function R(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,R(e,t),"throw"===t.method))return h;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return h}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,h;var i=n.arg;return i?i.done?(t[e.resultName]=i.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,h):i:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,h)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function m(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function _(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:b}}function b(){return{value:void 0,done:!0}}return l.prototype=g.constructor=d,d.constructor=l,l.displayName=a(d,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===l||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,a(e,s,"GeneratorFunction")),e.prototype=Object.create(g),e},e.awrap=function(e){return{__await:e}},x(w.prototype),w.prototype[o]=function(){return this},e.AsyncIterator=w,e.async=function(t,r,n,i,o){void 0===o&&(o=Promise);var s=new w(c(t,r,n,i),o);return e.isGeneratorFunction(r)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},x(g),a(g,s,"Generator"),g[i]=function(){return this},g.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=_,T.prototype={constructor:T,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(m),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return s.type="throw",s.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],s=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var a=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(a&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(a){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=e,s.arg=t,o?(this.method="next",this.next=o.finallyLoc,h):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),m(r),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;m(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:_(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),h}},e}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}}(y={exports:{}}),y.exports),x={NOT_ACCEPTABLE:406,BAD_REQUEST:400,UNAUTHORIZED:401,INTERNAL_SERVER_ERROR:500,OK:200};(v=exports.ErrorType||(exports.ErrorType={})).InvalidRequest="invalid_request",v.InvalidClient="invalid_client",v.InvalidGrant="invalid_grant",v.InvalidScope="invalid_scope",v.UnauthorizedClient="unauthorized_client",v.UnsupportedGrantType="unsupported_grant_type",v.AccessDenied="access_denied";var w=function(e){function t(t,r,n,i,o){var s;return void 0===o&&(o=x.BAD_REQUEST),(s=e.call(this,n?t+": "+n:t)||this).error=t,s.errorType=r,s.errorDescription=n,s.errorUri=i,s.status=o,Error.captureStackTrace(function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(s),s.constructor),s.name=s.constructor.name,s}return u(t,e),t.invalidRequest=function(e,r){return r=r||"Check the `"+e+"` parameter",new t("The request is missing a required parameter, includes an invalid parameter value, includes a parameter more than once, or is otherwise malformed",exports.ErrorType.InvalidRequest,r)},t.invalidClient=function(e){return new t("Client authentication failed",exports.ErrorType.InvalidClient,e,void 0,x.UNAUTHORIZED)},t.invalidGrant=function(e){return new t("The provided authorization grant (e.g., authorization_code, client_credentials) or refresh token is invalid, expired, revoked, or does not match the redirection URI used in the authorization request, or was issued to another client",exports.ErrorType.InvalidGrant,e)},t.invalidScope=function(e,r){var n="Specify a scope in the request or set a default scope";return e&&(n="Check the `"+e+"` scope(s)"),new t("The requested scope is invalid, unknown, or malformed",exports.ErrorType.InvalidScope,n,r)},t.unauthorizedClient=function(){return new t("unauthorized client",exports.ErrorType.UnauthorizedClient)},t.unsupportedGrantType=function(){return new t("unsupported grant_type",exports.ErrorType.UnsupportedGrantType)},t.logicException=function(e){return new t(e,exports.ErrorType.InvalidRequest)},t.accessDenied=function(e){return new t("The resource owner or authorization server denied the request",exports.ErrorType.AccessDenied,e,void 0,x.UNAUTHORIZED)},t}(f(Error)),R=function(){function e(){this.method="plain"}return e.prototype.verifyCodeChallenge=function(e,t){return t===e},e}();function k(e){return"string"==typeof e&&(e=Buffer.from(e)),e.toString("base64")}function m(e){return"string"==typeof e&&(e=Buffer.from(e,"base64")),e.toString("binary")}function T(e){return k(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}var _=function(){function e(){this.method="S256"}return e.prototype.verifyCodeChallenge=function(e,r){return r===T(t.createHash("sha256").update(e).digest())},e}(),b=function(e,t,r,n){if(this.grantTypeId=e,this.client=t,this.user=n,this.scopes=[],this.scopes=[],this.isAuthorizationApproved=!1,this.redirectUri=null!=r?r:t.redirectUris[0],!this.redirectUri)throw w.logicException("Unknown redirect_uri")},q=function(){function e(e){void 0===e&&(e={headers:{}}),this.status=200,this.body={},this.headers={},this.headers=c({},e.headers)}var t=e.prototype;return t.get=function(e){return console.log({headers:this.headers,field:e}),""},t.set=function(e,t){this.headers[e.toLowerCase()]=t},e}(),A=function(e){function t(t,r){var n;return(n=e.call(this,r)||this).set("Location",t),n.status=302,n}return u(t,e),t}(q),E=function(){function e(e){this.interval=e,this.ms=r(e)}var t=e.prototype;return t.getEndDate=function(){return new Date(this.getEndTimeMs())},t.getEndTimeMs=function(){return Date.now()+this.ms},t.getEndTimeSeconds=function(){return Math.ceil(this.getEndTimeMs()/1e3)},t.getSeconds=function(){return Math.ceil(this.ms/1e3)},e.getDateEnd=function(t){return new e(t).getEndDate()},e}();function C(e){return!!e.secret}var S=function(e){function t(t,r){var n;return(n=e.call(this,r)||this).accessToken=t,n.status=x.OK,n.set("pragma","no-cache"),n.set("cache-control","no-store"),n.set("content-type","application/json; charset=UTF-8"),n}return u(t,e),t}(q),P=function(e,t){return e.filter((function(e){return!t.includes(e)}))};function O(e){return z(e.getTime()-Date.now())}function z(e){return e instanceof Date&&(e=e.getTime()),Math.ceil(e/1e3)}var G=function(){function e(e,t,r,n,i,o){this.authCodeRepository=e,this.clientRepository=t,this.tokenRepository=r,this.scopeRepository=n,this.userRepository=i,this.jwt=o,this.options={requiresPKCE:!0},this.scopeDelimiterString=" ",this.supportedGrantTypes=["client_credentials","authorization_code","refresh_token","password","implicit"]}var t=e.prototype;return t.makeBearerTokenResponse=function(){var e=a(g.mark((function e(t,r,n,i){var o,s,a,c;return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===n&&(n=[]),void 0===i&&(i={}),o=n.map((function(e){return e.name})).join(this.scopeDelimiterString),e.next=5,this.encryptAccessToken(t,r,n,i);case 5:if(s=e.sent,a=void 0,!r.refreshToken){e.next=11;break}return e.next=10,this.encryptRefreshToken(t,r,n);case 10:a=e.sent;case 11:return(c=new S(r)).body={token_type:"Bearer",expires_in:O(r.accessTokenExpiresAt),access_token:s,refresh_token:a,scope:o},e.abrupt("return",c);case 14:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}(),t.encryptRefreshToken=function(e,t,r){var n,i,o,s=null!=(n=null==(i=t.refreshTokenExpiresAt)?void 0:i.getTime())?n:t.accessTokenExpiresAt.getTime();return this.encrypt({client_id:e.id,access_token_id:t.accessToken,refresh_token_id:t.refreshToken,scope:r.map((function(e){return e.name})).join(this.scopeDelimiterString),user_id:null==(o=t.user)?void 0:o.id,expire_time:Math.ceil(s/1e3)})},t.encryptAccessToken=function(e,t,r,n){var i;return this.encrypt(c({},n,{cid:e.name,scope:r.map((function(e){return e.name})).join(this.scopeDelimiterString),iss:void 0,sub:null==(i=t.user)?void 0:i.id,aud:void 0,exp:z(t.accessTokenExpiresAt.getTime()),nbf:z(Date.now()),iat:z(Date.now()),jti:t.accessToken}))},t.validateClient=function(){var e=a(g.mark((function e(t){var r,n,i,o,s;return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.getClientCredentials(t),n=r[0],i=r[1],o=this.getGrantType(t),e.next=4,this.clientRepository.getByIdentifier(n);case 4:if(!C(s=e.sent)||i){e.next=7;break}throw w.invalidClient("Confidential clients require client_secret.");case 7:return e.next=9,this.clientRepository.isClientValid(o,s,i);case 9:if(e.sent){e.next=12;break}throw w.invalidClient();case 12:if("client_credentials"!==o){e.next=15;break}if(s.secret&&s.secret===i){e.next=15;break}throw w.invalidClient("Invalid client_credentials");case 15:return e.abrupt("return",s);case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.getClientCredentials=function(e){var t=this.getBasicAuthCredentials(e),r=t[1],n=this.getRequestParameter("client_id",e,t[0]);if(!n)throw w.invalidRequest("client_id");var i=this.getRequestParameter("client_secret",e,r);return Array.isArray(n)&&n.length>0&&(n=n[0]),Array.isArray(i)&&i.length>0&&(i=i[0]),[n,i]},t.getBasicAuthCredentials=function(e){var t;if(null==(t=e.headers)||!t.hasOwnProperty("authorization"))return[void 0,void 0];var r=e.headers.authorization;if(!r||!r.startsWith("Basic "))return[void 0,void 0];var n=m(r.substr(6,r.length));return n.includes(":")?n.split(":"):[void 0,void 0]},t.validateScopes=function(){var e=a(g.mark((function e(t,r){var n,i;return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===t&&(t=[]),"string"==typeof t&&(t=t.split(this.scopeDelimiterString)),t&&0!==t.length&&""!==t[0]){e.next=4;break}return e.abrupt("return",[]);case 4:return e.next=6,this.scopeRepository.getAllByIdentifiers(t);case 6:if(!((i=P(t,(n=e.sent).map((function(e){return e.name})))).length>0)){e.next=10;break}throw w.invalidScope(i.join(", "),r);case 10:return e.abrupt("return",n);case 11:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),t.issueAccessToken=function(){var e=a(g.mark((function e(t,r,n,i){var o;return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===i&&(i=[]),e.next=3,this.tokenRepository.issueToken(r,i,n);case 3:return(o=e.sent).accessTokenExpiresAt=t.getEndDate(),e.next=7,this.tokenRepository.persist(o);case 7:return e.abrupt("return",o);case 8:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}(),t.issueRefreshToken=function(e){return this.tokenRepository.issueRefreshToken(e)},t.getGrantType=function(e){var t,r=null!=(t=this.getRequestParameter("grant_type",e))?t:this.getQueryStringParameter("grant_type",e);if(!r||!this.supportedGrantTypes.includes(r))throw w.invalidRequest("grant_type");if(this.identifier!==r)throw w.invalidRequest("grant_type","something went wrong");return r},t.getRequestParameter=function(e,t,r){var n,i;return null!=(n=null==(i=t.body)?void 0:i[e])?n:r},t.getQueryStringParameter=function(e,t,r){var n,i;return null!=(n=null==(i=t.query)?void 0:i[e])?n:r},t.encrypt=function(e){return this.jwt.sign(e)},t.decrypt=function(){var e=a(g.mark((function e(t){return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.jwt.verify(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.validateAuthorizationRequest=function(e){throw new Error("Grant does not support the request")},t.canRespondToAccessTokenRequest=function(e){return this.getRequestParameter("grant_type",e)===this.identifier},t.canRespondToAuthorizationRequest=function(e){return!1},t.completeAuthorizationRequest=function(){var e=a(g.mark((function e(t){return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Grant does not support the request");case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),t.respondToAccessTokenRequest=function(){var e=a(g.mark((function e(t,r,n){return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Grant does not support the request");case 1:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),e}(),L=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var r=t.prototype;return r.makeRedirectUrl=function(e,t,r){void 0===r&&(r="?");var i=e.includes(r)?"&":r;return e+i+n.stringify(t)},r.getRedirectUri=function(e,t){var r=this.getQueryStringParameter("redirect_uri",e);if(r)return Array.isArray(r)&&1===r.length&&(r=r[0]),this.validateRedirectUri(r,t),r},r.validateRedirectUri=function(e,t){if("string"!=typeof e||""===e)throw w.invalidRequest("redirect_uri");var r=i.parse(e);if(!r.scheme)throw w.invalidRequest("redirect_uri");if(r.fragment)throw w.invalidRequest("redirect_uri","Redirection endpoint must not contain url fragment based on RFC6749, section 3.1.2");if(!t.redirectUris.includes(e))throw w.invalidClient("Invalid redirect_uri");return e},t}(G),U=/^[A-Za-z0-9-._~]{43,128}$/,j=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).identifier="authorization_code",t.authCodeTTL=new E("15m"),t.codeChallengeVerifiers={plain:new R,S256:new _},t}u(t,e);var r=t.prototype;return r.respondToAccessTokenRequest=function(){var e=a(g.mark((function e(t,r,n){var i,o,s,a,c,u,h,p,l,d,f,v,y,x,R,k;return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.validateClient(t);case 2:if(s=e.sent,a=this.getRequestParameter("code",t)){e.next=6;break}throw w.invalidRequest("code");case 6:return e.next=8,this.decrypt(a);case 8:return c=e.sent,e.next=11,this.validateAuthorizationCode(c,s,t);case 11:if(!(h=(u=e.sent).user_id)){e.next=19;break}return e.next=16,this.userRepository.getUserByCredentials(h);case 16:e.t0=e.sent,e.next=20;break;case 19:e.t0=void 0;case 20:return p=e.t0,l=[],e.prev=22,e.t1=this.scopeRepository,e.next=26,this.validateScopes(null!=(d=u.scopes)?d:[]);case 26:return e.t2=e.sent,e.t3=this.identifier,e.t4=s,e.t5=h,e.next=32,e.t1.finalize.call(e.t1,e.t2,e.t3,e.t4,e.t5);case 32:e.sent.forEach((function(e){return l.push(e)})),e.next=39;break;case 36:throw e.prev=36,e.t6=e.catch(22),w.invalidRequest("code","Cannot verify scopes");case 39:return e.next=41,this.authCodeRepository.getByIdentifier(u.auth_code_id);case 41:if(!(f=e.sent).codeChallenge){e.next=57;break}if(u.code_challenge){e.next=45;break}throw w.invalidRequest("code_challenge");case 45:if(f.codeChallenge===u.code_challenge){e.next=47;break}throw w.invalidRequest("code_challenge","Provided code challenge does not match auth code");case 47:if(v=this.getRequestParameter("code_verifier",t)){e.next=50;break}throw w.invalidRequest("code_verifier");case 50:if(U.test(v)){e.next=52;break}throw w.invalidRequest("code_verifier","Code verifier must follow the specifications of RFS-7636");case 52:if(x=this.codeChallengeVerifiers.plain,"s256"===(null==(y=u.code_challenge_method)?void 0:y.toLowerCase())&&(x=this.codeChallengeVerifiers.S256),x.verifyCodeChallenge(v,u.code_challenge)){e.next=57;break}throw w.invalidGrant("Failed to verify code challenge.");case 57:return e.next=59,this.issueAccessToken(n,s,p,l);case 59:return R=e.sent,e.next=62,this.issueRefreshToken(R);case 62:return R=e.sent,e.next=65,this.authCodeRepository.revoke(u.auth_code_id);case 65:if(!p){e.next=71;break}return e.next=68,null==(i=(o=this.userRepository).extraAccessTokenFields)?void 0:i.call(o,p);case 68:e.t7=e.sent,e.next=72;break;case 71:e.t7=void 0;case 72:return k=e.t7,e.next=75,this.makeBearerTokenResponse(s,R,l,k);case 75:return e.abrupt("return",e.sent);case 76:case"end":return e.stop()}}),e,this,[[22,36]])})));return function(t,r,n){return e.apply(this,arguments)}}(),r.canRespondToAuthorizationRequest=function(e){var t=this.getQueryStringParameter("response_type",e),r=!!this.getQueryStringParameter("client_id",e);return"code"===t&&r},r.validateAuthorizationRequest=function(){var e=a(g.mark((function e(t){var r,n,i,o,s,a,c,u,h;return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("string"==typeof(r=this.getQueryStringParameter("client_id",t))){e.next=3;break}throw w.invalidRequest("client_id");case 3:return e.next=5,this.clientRepository.getByIdentifier(r);case 5:if(n=e.sent){e.next=8;break}throw w.invalidClient();case 8:return i=this.getRedirectUri(t,n),o=this.getQueryStringParameter("scope",t,[]),e.next=12,this.validateScopes(o);case 12:if(s=e.sent,a=this.getQueryStringParameter("state",t),(c=new b(this.identifier,n,i)).state=a,c.scopes=s,u=this.getQueryStringParameter("code_challenge",t),!this.options.requiresPKCE||u){e.next=20;break}throw w.invalidRequest("code_challenge","The authorization server requires public clients to use PKCE RFC-7636");case 20:return u&&(h=this.getQueryStringParameter("code_challenge_method",t,"plain"),c.codeChallenge=u,c.codeChallengeMethod=h),e.abrupt("return",c);case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),r.completeAuthorizationRequest=function(){var e=a(g.mark((function e(t){var r,n,i,o,s,a;return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.user){e.next=2;break}throw w.logicException("A user should be set on the authorization request");case 2:if(n=t.redirectUri){e.next=5;break}throw w.invalidRequest("redirect_uri");case 5:if(t.isAuthorizationApproved){e.next=7;break}throw w.logicException("Authorization is not approved");case 7:return e.next=9,this.issueAuthCode(this.authCodeTTL,t.client,t.user.id,t.redirectUri,t.codeChallenge,t.codeChallengeMethod,t.scopes);case 9:return o={client_id:(i=e.sent).client.id,redirect_uri:i.redirectUri,auth_code_id:i.code,scopes:i.scopes.map((function(e){return e.name})),user_id:null==(r=i.user)?void 0:r.id,expire_time:this.authCodeTTL.getEndTimeSeconds(),code_challenge:t.codeChallenge,code_challenge_method:t.codeChallengeMethod},s=JSON.stringify(o),e.next=14,this.encrypt(s);case 14:return a=this.makeRedirectUrl(n,{code:e.sent,state:t.state}),e.abrupt("return",new A(a));case 17:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),r.validateAuthorizationCode=function(){var e=a(g.mark((function e(t,r,n){var i,o;return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.auth_code_id){e.next=2;break}throw w.invalidRequest("code","Authorization code malformed");case 2:return e.next=4,this.authCodeRepository.isRevoked(t.auth_code_id);case 4:if(i=e.sent,!(Date.now()/1e3>t.expire_time||i)){e.next=7;break}throw w.invalidRequest("code","Authorization code is expired or revoked");case 7:if(t.client_id===r.id){e.next=9;break}throw w.invalidRequest("code","Authorization code was not issued to this client");case 9:if(o=this.getRequestParameter("redirect_uri",n),!t.redirect_uri||o){e.next=12;break}throw w.invalidRequest("redirect_uri");case 12:if(t.redirect_uri===o){e.next=14;break}throw w.invalidRequest("redirect_uri","Invalid redirect URI");case 14:return e.abrupt("return",t);case 15:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),r.issueAuthCode=function(){var e=a(g.mark((function e(t,r,n,i,o,s,a){var c,u;return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===a&&(a=[]),!n){e.next=7;break}return e.next=4,this.userRepository.getUserByCredentials(n);case 4:e.t0=e.sent,e.next=8;break;case 7:e.t0=void 0;case 8:return c=e.t0,e.next=11,this.authCodeRepository.issueAuthCode(r,c,a);case 11:return(u=e.sent).expiresAt=t.getEndDate(),u.redirectUri=i,u.codeChallenge=o,u.codeChallengeMethod=s,u.scopes=[],a.forEach((function(e){return u.scopes.push(e)})),e.next=20,this.authCodeRepository.persist(u);case 20:return e.abrupt("return",u);case 21:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,o,s,a){return e.apply(this,arguments)}}(),t}(L),D=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).identifier="client_credentials",t}return u(t,e),t.prototype.respondToAccessTokenRequest=function(){var e=a(g.mark((function e(t,r,n){var i,o,s,a;return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.validateClient(t);case 2:return i=e.sent,o=this.getRequestParameter("scope",t,[]),e.next=6,this.validateScopes(o);case 6:return s=e.sent,e.next=10,this.issueAccessToken(n,i,void 0,s);case 10:return a=e.sent,e.next=13,this.makeBearerTokenResponse(i,a,s);case 13:return e.abrupt("return",e.sent);case 14:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),t}(G),I=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).identifier="implicit",t.accessTokenTTL=new E("1h"),t}u(t,e);var r=t.prototype;return r.respondToAccessTokenRequest=function(e,t,r){throw w.logicException("The implicit grant can't respond to access token requests")},r.canRespondToAccessTokenRequest=function(e){var t=this.getQueryStringParameter("client_id",e);return"token"===this.getQueryStringParameter("response_type",e)&&!!t},r.validateAuthorizationRequest=function(){var e=a(g.mark((function e(t){var r,n,i,o,s,a;return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.getQueryStringParameter("client_id",t)){e.next=3;break}throw w.invalidRequest("client_id");case 3:return e.next=5,this.clientRepository.getByIdentifier(r);case 5:if(n=e.sent){e.next=8;break}throw w.invalidClient();case 8:return i=this.getRedirectUri(t,n),e.next=11,this.validateScopes(this.getQueryStringParameter("scope",t,[]),i);case 11:return o=e.sent,s=this.getQueryStringParameter("state",t),(a=new b(this.identifier,n,i)).state=s,a.scopes=o,e.abrupt("return",a);case 17:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),r.completeAuthorizationRequest=function(){var e=a(g.mark((function e(t){var r,n,i,o,s,a,c,u;return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.user&&null!=(r=t.user)&&r.id){e.next=2;break}throw w.logicException("A user must be set on the AuthorizationRequest");case 2:if((o=t.redirectUri)||(o=null==(s=t.client)?void 0:s.redirectUris[0]),o){e.next=6;break}throw w.invalidRequest("redirect_uri","Neither the request nor the client contain a valid refresh token");case 6:if(t.isAuthorizationApproved){e.next=8;break}throw w.accessDenied();case 8:return e.next=10,this.scopeRepository.finalize(t.scopes,this.identifier,t.client,t.user.id);case 10:return a=e.sent,e.next=13,this.issueAccessToken(this.accessTokenTTL,t.client,t.user,a);case 13:if(c=e.sent,!t.user){e.next=20;break}return e.next=17,null==(n=(i=this.userRepository).extraAccessTokenFields)?void 0:n.call(i,t.user);case 17:e.t0=e.sent,e.next=21;break;case 20:e.t0=void 0;case 21:return u=e.t0,e.next=24,this.encryptAccessToken(t.client,c,t.scopes,null!=u?u:{});case 24:return e.abrupt("return",new A(this.makeRedirectUrl(o,{access_token:e.sent,token_type:"Bearer",expires_in:O(c.accessTokenExpiresAt),state:t.state})));case 26:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t}(L),B=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).identifier="password",t}u(t,e);var r=t.prototype;return r.respondToAccessTokenRequest=function(){var e=a(g.mark((function e(t,r,n){var i,o,s,a,c,u,h,p;return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.validateClient(t);case 2:return s=e.sent,a=this.getRequestParameter("scope",t,[]),e.next=6,this.validateUser(t,s);case 6:return c=e.sent,e.t0=this.scopeRepository,e.next=10,this.validateScopes(a);case 10:return e.t1=e.sent,e.t2=this.identifier,e.t3=s,e.t4=c.id,e.next=16,e.t0.finalize.call(e.t0,e.t1,e.t2,e.t3,e.t4);case 16:return u=e.sent,e.next=19,this.issueAccessToken(n,s,c,u);case 19:return h=e.sent,e.next=22,this.issueRefreshToken(h);case 22:return h=e.sent,e.next=25,null==(i=(o=this.userRepository).extraAccessTokenFields)?void 0:i.call(o,c);case 25:return p=e.sent,e.next=28,this.makeBearerTokenResponse(s,h,u,p);case 28:return e.abrupt("return",e.sent);case 29:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),r.validateUser=function(){var e=a(g.mark((function e(t,r){var n,i,o;return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.getRequestParameter("username",t)){e.next=3;break}throw w.invalidRequest("username");case 3:if(i=this.getRequestParameter("password",t)){e.next=6;break}throw w.invalidRequest("password");case 6:return e.next=8,this.userRepository.getUserByCredentials(n,i,this.identifier,r);case 8:if(o=e.sent){e.next=11;break}throw w.invalidGrant();case 11:return e.abrupt("return",o);case 12:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),t}(G),F=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).identifier="refresh_token",t}u(t,e);var r=t.prototype;return r.respondToAccessTokenRequest=function(){var e=a(g.mark((function e(t,r,n){var i,o,s,a,c,u,h,p;return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.validateClient(t);case 2:return s=e.sent,e.next=5,this.validateOldRefreshToken(t,s.id);case 5:return c=(a=e.sent).user,e.next=9,this.validateScopes(this.getRequestParameter("scope",t,a.scopes.map((function(e){return e.name}))));case 9:return(u=e.sent).forEach((function(e){if(!a.scopes.map((function(e){return e.name})).includes(e.name))throw w.invalidScope(e.name)})),e.next=13,this.tokenRepository.revoke(a);case 13:return e.next=15,this.issueAccessToken(n,s,c,u);case 15:return h=e.sent,e.next=18,this.issueRefreshToken(h);case 18:if(h=e.sent,!c){e.next=25;break}return e.next=22,null==(i=(o=this.userRepository).extraAccessTokenFields)?void 0:i.call(o,c);case 22:e.t0=e.sent,e.next=26;break;case 25:e.t0=void 0;case 26:return p=e.t0,e.next=29,this.makeBearerTokenResponse(s,h,u,p);case 29:return e.abrupt("return",e.sent);case 30:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),r.validateOldRefreshToken=function(){var e=a(g.mark((function e(t,r){var n,i,o,s,a,c;return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=this.getRequestParameter("refresh_token",t)){e.next=3;break}throw w.invalidRequest("refresh_token");case 3:return e.prev=3,e.next=6,this.decrypt(s);case 6:a=e.sent,e.next=14;break;case 9:if(e.prev=9,e.t0=e.catch(3),"invalid signature"!==e.t0.message){e.next=13;break}throw w.invalidRequest("refresh_token","Cannot verify the refresh token");case 13:throw w.invalidRequest("refresh_token","Cannot decrypt the refresh token");case 14:if(null!=(n=a)&&n.refresh_token_id){e.next=16;break}throw w.invalidRequest("refresh_token","Token missing");case 16:if((null==(i=a)?void 0:i.client_id)===r){e.next=18;break}throw w.invalidRequest("refresh_token","Token is not linked to client");case 18:if(!(Date.now()/1e3>(null==(o=a)?void 0:o.expire_time))){e.next=20;break}throw w.invalidRequest("refresh_token","Token has expired");case 20:return e.next=22,this.tokenRepository.getByRefreshToken(a.refresh_token_id);case 22:return c=e.sent,e.next=25,this.tokenRepository.isRefreshTokenRevoked(c);case 25:if(!e.sent){e.next=27;break}throw w.invalidRequest("refresh_token","Token has been revoked");case 27:return e.abrupt("return",c);case 28:case"end":return e.stop()}}),e,this,[[3,9]])})));return function(t,r){return e.apply(this,arguments)}}(),t}(G),N=function(){function e(e,t,r,n,i,o,s){this.authCodeRepository=e,this.clientRepository=t,this.tokenRepository=r,this.scopeRepository=n,this.userRepository=i,this.jwt=o,this.enabledGrantTypes={},this.grantTypeAccessTokenTTL={},this.availableGrants={authorization_code:new j(this.authCodeRepository,this.clientRepository,this.tokenRepository,this.scopeRepository,this.userRepository,this.jwt),client_credentials:new D(this.authCodeRepository,this.clientRepository,this.tokenRepository,this.scopeRepository,this.userRepository,this.jwt),implicit:new I(this.authCodeRepository,this.clientRepository,this.tokenRepository,this.scopeRepository,this.userRepository,this.jwt),password:new B(this.authCodeRepository,this.clientRepository,this.tokenRepository,this.scopeRepository,this.userRepository,this.jwt),refresh_token:new F(this.authCodeRepository,this.clientRepository,this.tokenRepository,this.scopeRepository,this.userRepository,this.jwt)},this.setOptions(s)}var t=e.prototype;return t.setOptions=function(e){void 0===e&&(e={}),this.options=c({requiresPKCE:!0},e)},t.enableGrantType=function(e,t){void 0===t&&(t=new E("1h"));var r=this.availableGrants[e];r.options=this.options,this.enabledGrantTypes[e]=r,this.grantTypeAccessTokenTTL[e]=t},t.respondToAccessTokenRequest=function(e,t){for(var r=0,n=Object.values(this.enabledGrantTypes);r<n.length;r++){var i=n[r];if(i.canRespondToAccessTokenRequest(e))return i.respondToAccessTokenRequest(e,t,this.grantTypeAccessTokenTTL[i.identifier])}throw w.unsupportedGrantType()},t.validateAuthorizationRequest=function(e){for(var t=0,r=Object.values(this.enabledGrantTypes);t<r.length;t++){var n=r[t];if(n.canRespondToAuthorizationRequest(e))return n.validateAuthorizationRequest(e)}throw w.unsupportedGrantType()},t.completeAuthorizationRequest=function(){var e=a(g.mark((function e(t){var r;return g.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.enabledGrantTypes[t.grantTypeId],e.next=3,r.completeAuthorizationRequest(t);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.getGrant=function(e){return this.availableGrants[e]},e}(),Q=function(){function e(e){void 0===e&&(e={}),this.headers={},this.headers=c({},e.headers),this.query=c({},e.query),this.body=c({},e.body)}return e.prototype.set=function(e,t){this.headers[e.toLowerCase()]=t},e}(),M=function(){function e(e){this.secretOrPrivateKey=e}var t=e.prototype;return t.verify=function(e,t){var r=this;return void 0===t&&(t={}),new Promise((function(n,i){o.verify(e,r.secretOrPrivateKey,t,(function(e,t){t?n(t):i(e)}))}))},t.decode=function(e){return o.decode(e)},t.sign=function(e){var t=this;return new Promise((function(r,n){o.sign(e,t.secretOrPrivateKey,(function(e,t){t?r(t):n(e)}))}))},e}();exports.AbstractAuthorizedGrant=L,exports.AbstractGrant=G,exports.AuthCodeGrant=j,exports.AuthorizationRequest=b,exports.AuthorizationServer=N,exports.BearerTokenResponse=S,exports.ClientCredentialsGrant=D,exports.DateInterval=E,exports.HttpStatus=x,exports.ImplicitGrant=I,exports.JwtService=M,exports.OAuthException=w,exports.OAuthRequest=Q,exports.OAuthResponse=q,exports.PasswordGrant=B,exports.PlainVerifier=R,exports.REGEXP_CODE_CHALLENGE=/^[A-Za-z0-9-._~]{43,128}$/,exports.REGEXP_CODE_VERIFIER=U,exports.REGEX_ACCESS_TOKEN=/[A-Za-z0-9\-\._~\+\/]+=*/g,exports.RedirectResponse=A,exports.RefreshTokenGrant=F,exports.S256Verifier=_,exports.arrayDiff=P,exports.base64decode=m,exports.base64encode=k,exports.base64urlencode=T,exports.getSecondsUntil=O,exports.isClientConfidential=C,exports.roundToSeconds=z;
//# sourceMappingURL=oauth2-server.cjs.production.min.js.map
